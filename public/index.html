<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>投资日历</title>
    <style>
      :root {
        --border:#e6e6e6; --muted:#6e6e6e; --ok:#2ecc71; --warn:#e74c3c;
        --bg:#f7f7f8; --card:#ffffff; --primary:#ff7aa2; --primary-dark:#ff5c8a;
        --text:#222;
        --page-grad: linear-gradient(180deg, #fafafa 0%, #f5f6fa 100%);
        /* Instagram-like header gradient */
        --header-grad: linear-gradient(90deg, #f58529, #feda77, #dd2a7b, #8134af, #515bd4);
      }
      * { box-sizing: border-box; }
      
      body { font-family: -apple-system, system-ui, sans-serif; margin: 0; background: var(--page-grad); color: var(--text);height: 100vh;overflow: hidden; }
      header { padding: 14px 18px; display:flex; align-items:center; justify-content:space-between; background: var(--header-grad); color: #fff;
        box-shadow: 0 6px 16px rgba(0,0,0,0.12); }
      h1 { font-size: 18px; margin:0; letter-spacing:0.2px;display: flex;align-items: center;}
      .container { display:grid; grid-template-columns: 240px 1fr 480px; height: calc(100vh - 56px); }
      .sidebar { border-right: 1px solid var(--border); padding: 14px; overflow:auto; background: var(--bg); }
      .content { padding: 16px; overflow:auto; }
      .positions { border-left: 1px solid var(--border); padding: 16px; display:flex; flex-direction:column; background: var(--bg); }
      .date-item { padding: 10px 12px; border-radius: 14px; border:1px solid var(--border); margin-bottom:10px; cursor:pointer; background: var(--card);
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        transition: transform .15s ease, box-shadow .15s ease, border-color .2s ease; }
      .date-item:hover { transform: translateY(-1px); box-shadow: 0 6px 16px rgba(0,0,0,0.08); }
      .date-item.selected { border-color: var(--primary); box-shadow: 0 8px 20px rgba(255,92,138,0.18); background: linear-gradient(180deg, #fff 0%, #fff9fb 100%); }
      .badges { margin-top:6px; font-size:12px; color: var(--muted); display:flex; gap:8px; }
      .badge { padding:3px 8px; border:1px solid var(--border); border-radius:999px; background:#fff; box-shadow: 0 1px 2px rgba(0,0,0,0.04); }
      .badge.ok { color:#1a9f53; border-color:#1a9f53; background: #effaf3; }
      .badge.warn { color:#c0392b; border-color:#c0392b; background: #fff1f0; }
      .controls { margin-bottom: 10px; display:flex; gap:10px; align-items:center; }
      button { padding: 8px 14px; border-radius:999px; border: 1px solid var(--border); background: linear-gradient(180deg, #fff, #f8f8f8); cursor:pointer;
        box-shadow: 0 1px 2px rgba(0,0,0,0.04); transition: box-shadow .15s ease, transform .15s ease; }
      button:hover { box-shadow: 0 6px 16px rgba(0,0,0,0.08); transform: translateY(-1px); }
      button.active { border-color: var(--primary-dark); color: var(--primary-dark); background: linear-gradient(180deg, #fff, #fff5f8); box-shadow: 0 8px 20px rgba(255,92,138,0.18); }
      #generateBtn { border-color: var(--primary-dark); color: #fff; background: linear-gradient(180deg, var(--primary), var(--primary-dark)); }
      /* CTA 高亮，复用 generateBtn 的样式 */
      .btn-cta { border-color: var(--primary-dark) !important; color: #fff !important; background: linear-gradient(180deg, var(--primary), var(--primary-dark)) !important; box-shadow: 0 8px 20px rgba(255,92,138,0.18) !important; }
      .status { margin-left: 8px; color: var(--text); font-size: 12px; }
      textarea, pre { width: 100%; flex:1; font-family: ui-monospace, Menlo, monospace; }
      pre { white-space: pre-wrap; border:1px solid var(--border); border-radius:16px; padding:16px; min-height: 70vh; background: var(--card);
        box-shadow: 0 2px 6px rgba(0,0,0,0.06); }
      textarea { border:1px solid var(--border); border-radius:16px; min-height: 70vh; padding:14px; background: var(--card);
        box-shadow: 0 2px 6px rgba(0,0,0,0.06); color: var(--text); }
      textarea::placeholder { color: var(--muted); }
      /* Markdown rendering */
      .markdown { border:1px solid var(--border); border-radius:16px; padding:16px; min-height: 70vh; background: var(--card);
        box-shadow: 0 2px 6px rgba(0,0,0,0.06); }
      .markdown h1, .markdown h2, .markdown h3, .markdown h4, .markdown h5 { margin: 12px 0 8px; }
      .markdown p { margin: 8px 0; line-height: 1.7; }
      .markdown ul, .markdown ol { margin: 8px 0 8px 20px; }
      .markdown li { margin: 4px 0; }
      .markdown code { background:#f0f2f5; padding:2px 6px; border-radius:6px; }
      .markdown pre { background:#0f132a; color:#e6edf3; padding:12px; border-radius:12px; overflow:auto; }
      .markdown blockquote { margin:8px 0; padding:8px 12px; border-left:3px solid var(--primary-dark); background:#fff7fa; border-radius:6px; }
      .markdown a { color: var(--primary-dark); text-decoration: none; }

      /* Dark theme overrides */
      [data-theme="dark"] {
        --border:#2c2f36; --muted:#a0a6b3; --ok:#2ecc71; --warn:#e74c3c;
        --bg:#111317; --card:#1a1d22; --text:#e6edf3;
        --page-grad: linear-gradient(180deg, #0e1116 0%, #111317 100%);
        --header-grad: linear-gradient(90deg, #b85b13, #d38a1f, #b0235c, #5e2a93, #3a49b5);
      }
      [data-theme="dark"] button { border-color:#3a3f47; background: linear-gradient(180deg, #1c2026, #242a32); color: #e6edf3; }
      [data-theme="dark"] button.active { border-color:#ff7aa2; color:#ff7aa2; background: linear-gradient(180deg, #242a32, #2b3038); box-shadow: 0 8px 24px rgba(255,92,138,0.22); }
      [data-theme="dark"] .badge { background:#151922; border-color:#3a3f47; }
      [data-theme="dark"] .date-item { background:#151922; border-color:#2c2f36; }
      [data-theme="dark"] .date-item.selected { background: linear-gradient(180deg, #1c2026 0%, #1c1b20 100%); }
      [data-theme="dark"] .markdown pre { background:#0b0f1a; }
      .icon{
        width: 18px;
        height: 18px;
        margin-right: 8px;
      }
      /* Futures info bar styles */
      .info-row { display:flex; flex-wrap:wrap; gap:10px 16px; align-items:center; font-size:13px; }
      .info-item { display:flex; gap:6px; }
      .info-label { color: var(--muted); }
      .info-val { font-weight:600; }
      .info-val.up { color: var(--warn); }   /* 涨：红 */
      .info-val.down { color: var(--ok); }   /* 跌：绿 */
      /* Bubble color variables */
      :root { --bubble-user-bg:#f0f4ff; --bubble-user-border:#d0daf7; --bubble-assistant-bg:#fff7fa; --bubble-assistant-border:#ffd3e1; }
      [data-theme="dark"] { --bubble-user-bg:#1c2333; --bubble-user-border:#2b3450; --bubble-assistant-bg:#2a1c24; --bubble-assistant-border:#3a2a36; }
      /* Chat bubbles */
      .chat-row { display:flex; margin:8px 0; }
      .chat-row.user { justify-content:flex-end; }
      .chat-row.assistant { justify-content:flex-start; }
      .chat-bubble { max-width: 68%; padding:10px 12px; border-radius:14px; border:1px solid var(--border); background: var(--card); box-shadow: 0 1px 2px rgba(0,0,0,0.04); }
      .chat-bubble.user { background: var(--bubble-user-bg); border-color: var(--bubble-user-border); }
      .chat-bubble.assistant { background: var(--bubble-assistant-bg); border-color: var(--bubble-assistant-border); }
      .chat-name { font-size: 12px; color: var(--muted); margin-bottom: 4px; }
      .chat-content { color: var(--text); }

      /* Stock HQ table (small font, highlight changes) */
      .hq-wrap { margin-top: 12px; border:1px solid var(--border); border-radius: 12px; background: var(--card); box-shadow: 0 2px 6px rgba(0,0,0,0.06); overflow: hidden; }
      .hq-header { padding: 8px 12px; font-size: 12px; color: var(--muted); border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; }
      .hq-table { width: 100%; border-collapse: collapse; font-size: 12px; }
      .hq-table th, .hq-table td { padding: 6px 8px; border-bottom: 1px solid var(--border); text-align: right; }
      .hq-table th { text-align: right; color: var(--muted); font-weight: 600; }
      .hq-table td.name, .hq-table th.name { text-align: left; }
      .chg-up { color: #e74c3c; font-weight: 700; }
      .chg-down { color: #2ecc71; font-weight: 700; }
      .hq-table tr:hover { background: rgba(0,0,0,0.03); }
    </style>
  </head>
  <body>
    <header>
      <h1>
        <svg t="1762052320286" class="icon" viewBox="0 0 1025 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5189" width="200" height="200">
          <path fill="#fff" d="M512.444583 263.628267A250.814562 250.814562 0 1 0 758.57439 514.442829a249.012733 249.012733 0 0 0-246.129807-250.814562z m0 398.204154a147.389592 147.389592 0 1 1 144.1463-147.389592 145.587763 145.587763 0 0 1-144.1463 147.389592zM512.444583 235.339556a115.31704 115.31704 0 0 0 114.416126-116.037772A114.416126 114.416126 0 1 0 398.20864 118.581053a115.31704 115.31704 0 0 0 114.235943 116.758503z m0-164.867331A47.928645 47.928645 0 0 1 560.373228 118.581053a47.02773 47.02773 0 1 1-94.055461 0 47.928645 47.928645 0 0 1 46.126816-48.829559zM909.027091 398.405058a116.037772 116.037772 0 1 0 114.235943 116.037771 115.31704 115.31704 0 0 0-114.235943-116.037771z m0 164.687148a48.829559 48.829559 0 1 1 46.847547-48.649377 47.928645 47.928645 0 0 1-46.847547 48.649377z" p-id="5190"></path>
          <path fill="#fff" d="M512.444583 791.924457a116.037772 116.037772 0 1 0 114.416126 116.037771 115.31704 115.31704 0 0 0-114.416126-116.037771z m0 164.687148a48.649376 48.649376 0 1 1 47.928645-48.649377 47.928645 47.928645 0 0 1-47.928645 48.108828zM116.042258 398.405058a116.037772 116.037772 0 0 0 0 232.075543 116.037772 116.037772 0 0 0 0-232.075543z m0 164.687148a48.829559 48.829559 0 0 1 0-97.478936 48.829559 48.829559 0 0 1 0 97.478936z" p-id="5191"></path></svg>
        AI助理
      </h1>
      <div class="controls">
        <input id="dateInput" type="date" />
        <button id="themeToggleBtn">切换为黑暗</button>
        <span class="status" id="status">状态：空闲</span>
      </div>
    </header>
    <div class="container">
      <aside class="sidebar" id="sidebar"></aside>
      <main class="content">
        <div class="controls">
          <button id="refreshBtn" style="display: none;">刷新日期</button>
          <button id="showChatBtn">显示聊天</button>
          <button id="startChatBtn">开始对话</button>
          <button id="syncPrevBtn" style="display:none;">同步上一天</button>
          <button id="showFuturesBtn">显示当前期货走势</button>
          <button id="showWeeklyBtn">显示周线走势</button>

        </div>
        <div id="advice" class="markdown">选择左侧日期以查看内容...</div>
        <div id="futuresInfo" style="display:none;margin-top:12px;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background: var(--card);color: var(--text); box-shadow: 0 1px 3px rgba(0,0,0,0.05);"></div>
        <div id="futuresChart" style="width:100%;height:360px;display:none;border:1px solid var(--border);border-radius:16px;background: var(--card);box-shadow: 0 2px 6px rgba(0,0,0,0.06); margin-top:12px;"></div>
        <div id="stockHq" class="hq-wrap" style="display:none;">
          <div class="hq-header">
            <span>纳斯达克实时行情（Top 20）</span>
          </div>
          <div style="overflow:auto;">
            <table class="hq-table" id="stockHqTable">
              <thead>
                <tr>
                  <th class="name">名称</th>
                  <th>代码</th>
                  <th>最新价</th>
                  <th>涨跌额</th>
                  <th>涨跌幅</th>
                  <th>昨收</th>
                  <th>今开</th>
                  <th>最高</th>
                  <th>最低</th>
                  <th>市值</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
        <div id="chatPanel" style="display:none;margin-top:12px;border:1px solid var(--border);border-radius:16px;background: var(--card);box-shadow: 0 2px 6px rgba(0,0,0,0.06);">
          <div id="chatMeta" style="padding:10px 12px;border-bottom:1px solid var(--border);font-size:12px;color: var(--muted);"></div>
          <div id="chatMessages" style="max-height:70vh;overflow:auto;padding:12px;"></div>
          <div style="display:flex;gap:8px;border-top:1px solid var(--border);padding:10px 12px;">
            <input id="chatInput" type="text" placeholder="输入消息..." style="flex:1;border:1px solid var(--border);border-radius:12px;padding:8px;background: var(--card);color: var(--text);" />
            <button id="sendChatBtn">发送</button>
            <button id="fetchLatestBtn">获取最新消息</button>
          </div>
        </div>
      </main>
      <section class="positions">
        <div class="controls" style="flex-wrap:wrap; gap:8px 10px; align-items:center;">
          <span style="font-size:12px;color:var(--muted);">添加资产项：</span>
          <select id="assetCategory" style="width:120px;border:1px solid var(--border);border-radius:12px;padding:8px;background: var(--card);color: var(--text);">
            <option value="fund">基金</option>
            <option value="cash">现金</option>
            <option value="stock">股票</option>
            <option value="other">其他</option>
          </select>
          <input id="assetName" placeholder="资产名称（如 纳斯达克）" style="width:260px;border:1px solid var(--border);border-radius:12px;padding:8px;background: var(--card);color: var(--text);" />
          <input id="assetAmount" type="number" step="0.01" placeholder="金额（元）" style="width:140px;border:1px solid var(--border);border-radius:12px;padding:8px;background: var(--card);color: var(--text);" />
          <input id="posNote" placeholder="备注（可选）" style="flex:1;min-width:160px;border:1px solid var(--border);border-radius:12px;padding:8px;background: var(--card);color: var(--text);" />
          <button id="addPosBtn">添加资产</button>
        </div>
        <div id="positionsList" class="markdown" style="min-height: 70vh;"></div>
      </section>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <script>
      const $ = (id) => document.getElementById(id);
      const todayStr = new Date().toISOString().slice(0,10);
      let selectedDate = todayStr;
      
      
      let viewMode = 'chat'; // 默认聊天视图
      let futuresChartInstance = null;
      let futuresTimer = null;
      $('dateInput').value = todayStr;
      // 初始激活默认视图按钮
      setActiveView(viewMode);

      // Theme management
      function applyTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
        const btn = $('themeToggleBtn');
        if (btn) btn.textContent = theme === 'dark' ? '切换为明亮' : '切换为黑暗';
      }
      const savedTheme = localStorage.getItem('theme') || 'light';
      applyTheme(savedTheme);
      $('themeToggleBtn').addEventListener('click', () => {
        const cur = document.documentElement.getAttribute('data-theme') || 'light';
        applyTheme(cur === 'dark' ? 'light' : 'dark');
      });

      function setActiveView(view) {
        const map = {
          advice: 'showAdviceBtn',
          futures: 'showFuturesBtn',
          weekly: 'showWeeklyBtn',
          chat: 'showChatBtn',
        };
        ['showAdviceBtn', 'showFuturesBtn', 'showWeeklyBtn', 'showChatBtn'].forEach(id => {
          const el = $(id);
          if (!el) return;
          el.classList.toggle('active', id === map[view]);
        });
      }

      
      async function listChats() {
        try { const res = await fetch('/chats'); const data = await res.json(); return data.dates || []; }
        catch (e) { return []; }
      }

      function renderSidebar(chatDates) {
        const wrap = $('sidebar');
        wrap.innerHTML = '';
        // 倒序（今日在上、历史在下）
        for (let i = 0; i <= 27; i++) {
          const d = new Date(); d.setDate(d.getDate() - i);
          const ds = d.toISOString().slice(0,10);
          const hasChat = chatDates.includes(ds);
          const item = document.createElement('div');
          item.className = 'date-item' + (selectedDate === ds ? ' selected' : '');
          item.innerHTML = `<div><strong>${ds}</strong>${ds===todayStr?'（今日）':''}</div>
            <div class="badges">
              <span class="badge ${hasChat?'ok':''}">对话${hasChat?'✓':''}</span>
            </div>`;
          item.addEventListener('click', () => { selectedDate = ds; $('dateInput').value = ds; loadAllForDate(ds); renderSidebar(chatDates); });
          wrap.appendChild(item);
        }
      }

      

      async function fetchPositions(date) {
        // 仅使用全局 assets.json（单一事实来源）
        try {
          const resA = await fetch(`/assets`);
          if (resA.ok) {
            const data = await resA.json();
            return { entries: (Array.isArray(data?.entries) ? data.entries : []), totalAssets: Number(data?.totalAssets || 0) };
          }
        } catch (e) {}
        return { entries: [], totalAssets: 0 };
      }

      

      function sanitizeHref(href) {
        try {
          const u = new URL(href, window.location.origin);
          if (["http:", "https:", "mailto:"].includes(u.protocol)) return u.href;
        } catch (e) {}
        return '#';
      }

      function mdToHtml(md) {
        if (!md) return '';
        let text = md.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        const codeBlocks = [];
        text = text.replace(/```([\s\S]*?)```/g, (_, code) => {
          const idx = codeBlocks.length;
          codeBlocks.push(`<pre><code>${code}</code></pre>`);
          return `%%CODE_BLOCK_${idx}%%`;
        });
        text = text.replace(/^######\s+(.*)$/gm, '<h6>$1</h6>')
                   .replace(/^#####\s+(.*)$/gm, '<h5>$1</h5>')
                   .replace(/^####\s+(.*)$/gm, '<h4>$1</h4>')
                   .replace(/^###\s+(.*)$/gm, '<h3>$1</h3>')
                   .replace(/^##\s+(.*)$/gm, '<h2>$1</h2>')
                   .replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
        text = text.replace(/^---$/gm, '<hr/>')
                   .replace(/^>\s+(.*)$/gm, '<blockquote>$1</blockquote>');
        const lines = text.split('\n');
        let out = [], inUl = false, inOl = false;
        for (const ln of lines) {
          if (/^\s*[-*]\s+/.test(ln)) {
            if (!inUl) { out.push('<ul>'); inUl = true; }
            out.push('<li>' + ln.replace(/^\s*[-*]\s+/, '') + '</li>');
          } else if (/^\s*\d+\.\s+/.test(ln)) {
            if (!inOl) { out.push('<ol>'); inOl = true; }
            out.push('<li>' + ln.replace(/^\s*\d+\.\s+/, '') + '</li>');
          } else {
            if (inUl) { out.push('</ul>'); inUl = false; }
            if (inOl) { out.push('</ol>'); inOl = false; }
            out.push(ln);
          }
        }
        if (inUl) out.push('</ul>');
        if (inOl) out.push('</ol>');
        text = out.join('\n');
        text = text.replace(/`([^`]+)`/g, '<code>$1</code>')
                   .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
                   .replace(/(^|\s)\*([^*]+)\*/g, '$1<em>$2</em>')
                   .replace(/\[([^\]]+)\]\(([^)]+)\)/g, (_, t, href) => `<a href="${sanitizeHref(href)}" target="_blank" rel="noopener noreferrer">${t}</a>`);
        const blocks = text.split(/\n\n+/);
        text = blocks.map(b => /<(h\d|ul|ol|pre|blockquote|hr|p|div|code)/.test(b) ? b : `<p>${b}</p>`).join('\n');
        text = text.replace(/%%CODE_BLOCK_(\d+)%%/g, (_, i) => codeBlocks[Number(i)] || '');
        return text;
      }

      function escapeHtml(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
      let currentPositions = [];
      function renderPositions() {
        const el = $('positionsList');
        if (!el) return;
        if (!currentPositions.length) { el.innerHTML = '<p>暂无资产项，先输入总资产，再添加资产项以计算占比。</p>'; return; }
        const includeCats = new Set(['cash','fund']);
        const computedTotal = currentPositions.reduce((s,e) => {
          const cat = (e && typeof e.category === 'string' && e.category) ? e.category : 'fund';
          const amt = Number(e?.amount ?? 0);
          return (includeCats.has(cat) && Number.isFinite(amt)) ? s + amt : s;
        }, 0);
        const rows = currentPositions.map((e, idx) => {
          const name = escapeHtml(e.assetName ?? e.fundName ?? e.symbol ?? e.code ?? e.fundCode ?? '');
          const amount = Number(e.amount ?? 0);
          const cat = escapeHtml((e && typeof e.category === 'string' && e.category) ? e.category : 'fund');
          const note = escapeHtml(e.note ?? '');
          const pct = (Number.isFinite(computedTotal) && computedTotal > 0 && Number.isFinite(amount) && amount >= 0)
            ? ((amount / computedTotal) * 100).toFixed(2) + '%'
            : '-';
          const profit = Number(e.profit ?? 0);
          const shares = Number(e.shares ?? e.qty ?? e.volume ?? 0);
          const cost = Number(e.cost ?? e.price ?? 0);
          const principal = (Number.isFinite(shares) && shares > 0 && Number.isFinite(cost) && cost > 0)
            ? shares * cost
            : (Number.isFinite(amount) && amount > 0 ? amount : 0);
          const yieldPct = (Number.isFinite(principal) && principal > 0 && Number.isFinite(profit) && profit !== 0)
            ? ((profit / principal) * 100).toFixed(2) + '%'
            : '-';
          return `<tr>
            <td style="padding:4px;border-bottom:1px solid var(--border);word-break:break-word;font-size:12px;">${name}</td>
            <td style="padding:4px;border-bottom:1px solid var(--border);text-align:right;font-size:12px;">${Number.isFinite(amount) ? amount.toFixed(2) : '-'}</td>
            <td style="padding:4px;border-bottom:1px solid var(--border);text-align:right;font-size:12px;">${pct}</td>
            <td style="padding:4px;border-bottom:1px solid var(--border);text-align:right;font-size:12px;">${Number.isFinite(profit) ? profit.toFixed(2) : '-'}</td>
            <td style="padding:4px;border-bottom:1px solid var(--border);text-align:right;font-size:12px;">${yieldPct}</td>
            <td style="padding:4px;border-bottom:1px solid var(--border);text-align:right;font-size:12px;">
              <button class="pos-edit" data-idx="${idx}" style="padding:4px 8px;border:1px solid var(--border);border-radius:8px;background:var(--card);color:var(--text);">更改金额</button>
              <button class="pos-profit-edit" data-idx="${idx}" style="margin-left:8px;padding:4px 8px;border:1px solid var(--border);border-radius:8px;background:var(--card);color:var(--text);">更改收益</button>
              <button class="pos-delete" data-idx="${idx}" style="margin-left:8px;padding:4px 8px;border:1px solid var(--border);border-radius:8px;background:#2b2b2b;color:#f66;">删除</button>
            </td>
          </tr>`;
        }).join('');
        const totalRow = `<div style="margin-bottom:8px;font-size:13px;color:var(--muted);">总资产（现金+基金）：<strong>${Number.isFinite(computedTotal) ? computedTotal.toFixed(2) : 0}</strong> 元</div>`;
        el.innerHTML = `
          ${totalRow}
          <table style="width:100%;border-collapse:collapse;">
            <thead>
              <tr>
                <th style="text-align:left;padding:8px;border-bottom:1px solid var(--border);font-size:12px;">资产</th>
                <th style="text-align:right;padding:8px;border-bottom:1px solid var(--border);font-size:12px;">金额</th>
                <th style="text-align:right;padding:8px;border-bottom:1px solid var(--border);font-size:12px;">占比</th>
                <th style="text-align:right;padding:8px;border-bottom:1px solid var(--border);font-size:12px;">累计收益</th>
                <th style="text-align:right;padding:8px;border-bottom:1px solid var(--border);font-size:12px;">收益率</th>
                <th style="text-align:right;padding:8px;border-bottom:1px solid var(--border);font-size:12px;">操作</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>`;
      }
      // 资产行的编辑/删除事件委托
      $('positionsList').addEventListener('click', async (ev) => {
        const t = ev.target;
        if (!(t instanceof HTMLElement)) return;
        const idxStr = t.getAttribute('data-idx');
        const idx = idxStr ? Number(idxStr) : NaN;
        if (t.classList.contains('pos-delete')) {
          if (!Number.isFinite(idx)) return;
          const name = currentPositions[idx]?.assetName ?? '';
          const ok = confirm(`确定删除资产“${name}”吗？`);
          if (!ok) return;
          const next = currentPositions.filter((_, i) => i !== idx);
          currentPositions = next;
          await savePositions(currentPositions);
          renderPositions();
        }
        if (t.classList.contains('pos-edit')) {
          if (!Number.isFinite(idx)) return;
          const old = Number(currentPositions[idx]?.amount ?? 0);
          const input = prompt('请输入新的金额（元）', String(old));
          if (input == null) return; // cancelled
          const val = Number(String(input).trim());
          if (!Number.isFinite(val) || val < 0) { $('status').textContent = '状态：金额必须为非负数'; return; }
          const next = currentPositions.slice();
          next[idx] = { ...next[idx], amount: val };
          currentPositions = next;
          await savePositions(currentPositions);
          renderPositions();
        }
        if (t.classList.contains('pos-profit-edit')) {
          if (!Number.isFinite(idx)) return;
          const oldP = Number(currentPositions[idx]?.profit ?? 0);
          const inputP = prompt('请输入该行的累计收益（元）', String(oldP));
          if (inputP == null) return; // cancelled
          const valP = Number(String(inputP).trim());
          if (!Number.isFinite(valP)) { $('status').textContent = '状态：收益必须是数值'; return; }
          const next = currentPositions.slice();
          next[idx] = { ...next[idx], profit: valP };
          currentPositions = next;
          await savePositions(currentPositions);
          renderPositions();
        }
      });
      async function savePositions(entries) {
        const includeCats = new Set(['cash','fund']);
        const total = entries.reduce((s,e) => {
          const cat = (e && typeof e.category === 'string' && e.category) ? e.category : 'fund';
          const amt = Number(e?.amount ?? 0);
          return (includeCats.has(cat) && Number.isFinite(amt)) ? s + amt : s;
        }, 0);
        $('status').textContent = '状态：保存仓位中...';
        await fetch(`/assets`, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ entries, totalAssets: total }) });
        $('status').textContent = '状态：仓位已保存（总资产已自动计算）';
        refreshSidebar();
      }

      function renderAdvice(html) { $('advice').innerHTML = html; }
      function updateStatus(message) {
        const viewLabel = viewMode === 'chat' ? '聊天' : (viewMode === 'futures' ? '期货' : (viewMode === 'weekly' ? '周线' : '文本'));
        $('status').textContent = `状态：${message}（视图：${viewLabel}）`;
      }

      

      async function loadAllForDate(date) {
        updateStatus('读取中...');
        // 仅读取仓位，聊天作为默认视图
        const posData = await fetchPositions(date);
        currentPositions = posData.entries || [];
        renderPositions();
        // 切换到聊天视图
        viewMode = 'chat';
        setActiveView('chat');
        if (futuresTimer) { clearInterval(futuresTimer); futuresTimer = null; }
        // 隐藏图表，显示聊天或提示
        showChart(false);
        await updateChatControls(date);
        const chat = await fetchChat(date);
        if (!chat) {
          renderAdvice('该日暂无聊天记录，请先点击“开始对话”');
          showChat(false);
          updateStatus('无聊天记录');
          return;
        }
        renderChat(chat);
        updateStatus('聊天记录读取完成');
      }

      async function refreshSidebar() {
        const chats = await listChats();
        renderSidebar(chats);
      }

      $('refreshBtn').addEventListener('click', refreshSidebar);
      
      
      async function fetchFutures(date) {
        const res = await fetch(`/futures/${date}`);
        if (res.status === 404) return null;
        return await res.json();
      }
      function showChart(show) {
        $('futuresChart').style.display = show ? 'block' : 'none';
        $('futuresInfo').style.display = show ? 'block' : 'none';
        $('stockHq').style.display = show ? 'block' : 'none';
        $('advice').style.display = show ? 'none' : 'block';
        $('chatPanel').style.display = show ? 'none' : (viewMode === 'chat' ? 'block' : 'none');
      }
      async function renderFutures(date) {
        updateStatus('期货走势读取中...');
        const data = await fetchFutures(date);
        if (!data || !Array.isArray(data.values) || data.values.length === 0) {
          showChart(false);
          renderAdvice('');
          updateStatus('该日无期货数据');
          return;
        }
        showChart(true);
        const el = $('futuresChart');
        el.style.paddingLeft = '0px';
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        const cs = getComputedStyle(document.documentElement);
        const textColor = cs.getPropertyValue('--text').trim() || (isDark ? '#e6edf3' : '#222');
        const borderColor = cs.getPropertyValue('--border').trim() || (isDark ? '#2c2f36' : '#e6e6e6');
        const bgColor = cs.getPropertyValue('--card').trim() || (isDark ? '#1a1d22' : '#ffffff');
        const chart = echarts.getInstanceByDom(el) || echarts.init(el, isDark ? 'dark' : null);
        futuresChartInstance = chart;
        const fmtPrice = (v) => { return v.toFixed(2) };
        const first = data.values?.[0] ?? null;
        const last = data.values?.[data.values.length - 1] ?? null;
        const openPrice = (data.dayOpen != null && Number.isFinite(Number(data.dayOpen)))
          ? Number(data.dayOpen)
          : (first ? Number(first[0]) : null);
        const lastClose = (data.lastClose != null && Number.isFinite(Number(data.lastClose))) ? Number(data.lastClose) : null;
        const latestClose = last ? Number(last[1]) : null;
        const maxHigh = data.values.reduce((m, v) => Math.max(m, Number(v?.[3] ?? m)), Number.MIN_SAFE_INTEGER);
        const minLow = data.values.reduce((m, v) => Math.min(m, Number(v?.[2] ?? m)), Number.MAX_SAFE_INTEGER);
        const baseRef = Number.isFinite(lastClose) ? lastClose : openPrice;
        const diff = (Number.isFinite(latestClose) && Number.isFinite(baseRef)) ? (latestClose - baseRef) : null;
        const diffPct = (Number.isFinite(latestClose) && Number.isFinite(baseRef) && baseRef !== 0)
          ? ((latestClose - baseRef) / baseRef * 100) : null;
        const changeClass = diff == null ? '' : ((diff >= 0) ? 'up' : 'down');
        const infoHtml = `
          <div class="info-row">
            <div class="info-item"><span class="info-label">开盘价：</span><span class="info-val">${openPrice != null ? fmtPrice(openPrice) : '-'}</span></div>
            <div class="info-item"><span class="info-label">昨日收盘：</span><span class="info-val">${Number.isFinite(lastClose) ? fmtPrice(lastClose) : '-'}</span></div>
            <div class="info-item"><span class="info-label">最新价：</span><span class="info-val ${changeClass} pill">${latestClose != null ? (latestClose >= (baseRef ?? latestClose) ? '▲ ' : '▼ ') + fmtPrice(latestClose) : '-'}</span></div>
            <div class="info-item"><span class="info-label">涨跌额：</span><span class="info-val ${changeClass} pill">${diff != null ? (diff >= 0 ? '+' : '') + fmtPrice(diff) : '-'}</span></div>
            <div class="info-item"><span class="info-label">涨跌幅：</span><span class="info-val ${changeClass} pill">${diffPct != null ? (diff >= 0 ? '+' : '') + diffPct.toFixed(2) + '%' : '-'}</span></div>
            <div class="info-item"><span class="info-label">最高价：</span><span class="info-val">${Number.isFinite(maxHigh) ? fmtPrice(maxHigh) : '-'}</span></div>
            <div class="info-item"><span class="info-label">最低价：</span><span class="info-val">${Number.isFinite(minLow) ? fmtPrice(minLow) : '-'}</span></div>
          </div>`;
        $('futuresInfo').innerHTML = infoHtml;
        const option = {
          title: { text: data.name || '期货走势', left: 'center', textStyle: { fontSize: 14 } },
          tooltip: { trigger: 'axis' },
          backgroundColor: bgColor,
          xAxis: { type: 'category', data: data.times, boundaryGap: true, axisLine: { lineStyle: { color: borderColor } }, axisLabel: { color: textColor } },
          yAxis: { scale: true, min: 'dataMin', max: 'dataMax', splitNumber: 5,
            axisLine: { lineStyle: { color: borderColor } },
            axisLabel: { color: textColor, formatter: (val) => fmtPrice(val), margin: 8 },
            splitLine: { lineStyle: { color: borderColor } }
          },
          series: [{
            type: 'candlestick',
            data: data.values,
            itemStyle: { color: '#e74c3c', color0: '#2ecc71', borderColor: '#e74c3c', borderColor0: '#2ecc71' }
          }],
          grid: { left: 32, right: 24, top: 40, bottom: 30, containLabel: true },
          dataZoom: [{ type: 'inside', start: 0, end: 100 }],
          axisPointer: { type: 'cross' }
        };
        chart.setOption(option);
        updateStatus('期货走势展示完成');
        // 首次渲染股票行情表
        await renderStockHq();
        // 重启每分钟自动刷新（针对传入的日期）
        futuresTimer = setInterval(async () => {
          if (viewMode !== 'futures') return;
          const data2 = await fetchFutures(selectedDate);
          if (!data2 || !Array.isArray(data2.values) || data2.values.length === 0) return;
          const first2 = data2.values?.[0] ?? null;
          const last2 = data2.values?.[data2.values.length - 1] ?? null;
          const open2 = (data2.dayOpen != null && Number.isFinite(Number(data2.dayOpen))) ? Number(data2.dayOpen) : (first2 ? Number(first2[0]) : null);
          const lastClose2 = (data2.lastClose != null && Number.isFinite(Number(data2.lastClose))) ? Number(data2.lastClose) : null;
          const close2 = last2 ? Number(last2[1]) : null;
          const maxHigh2 = data2.values.reduce((m, v) => Math.max(m, Number(v?.[3] ?? m)), Number.MIN_SAFE_INTEGER);
          const minLow2 = data2.values.reduce((m, v) => Math.min(m, Number(v?.[2] ?? m)), Number.MAX_SAFE_INTEGER);
          const baseRef2 = Number.isFinite(lastClose2) ? lastClose2 : open2;
          const diff2 = (Number.isFinite(close2) && Number.isFinite(baseRef2)) ? (close2 - baseRef2) : null;
          const pct2 = (Number.isFinite(close2) && Number.isFinite(baseRef2) && baseRef2 !== 0) ? ((close2 - baseRef2) / baseRef2 * 100) : null;
          const changeClass2 = diff2 == null ? '' : ((diff2 >= 0) ? 'up' : 'down');
          const fmt = (v) => Number(v).toFixed(2);
          $('futuresInfo').innerHTML = `
            <div class=\"info-row\">
              <div class=\"info-item\"><span class=\"info-label\">开盘价：</span><span class=\"info-val\">${open2 != null ? fmt(open2) : '-'}</span></div>
              <div class=\"info-item\"><span class=\"info-label\">昨日收盘：</span><span class=\"info-val\">${Number.isFinite(lastClose2) ? fmt(lastClose2) : '-'}</span></div>
              <div class=\"info-item\"><span class=\"info-label\">最新价：</span><span class=\"info-val ${changeClass2} pill\">${close2 != null ? (close2 >= (baseRef2 ?? close2) ? '▲ ' : '▼ ') + fmt(close2) : '-'}</span></div>
              <div class=\"info-item\"><span class=\"info-label\">涨跌额：</span><span class=\"info-val ${changeClass2} pill\">${diff2 != null ? (diff2 >= 0 ? '+' : '') + fmt(diff2) : '-'}</span></div>
              <div class=\"info-item\"><span class=\"info-label\">涨跌幅：</span><span class=\"info-val ${changeClass2} pill\">${pct2 != null ? (diff2 >= 0 ? '+' : '') + pct2.toFixed(2) + '%' : '-'}</span></div>
              <div class=\"info-item\"><span class=\"info-label\">最高价：</span><span class=\"info-val\">${Number.isFinite(maxHigh2) ? fmt(maxHigh2) : '-'}</span></div>
              <div class=\"info-item\"><span class=\"info-label\">最低价：</span><span class=\"info-val\">${Number.isFinite(minLow2) ? fmt(minLow2) : '-'}</span></div>
            </div>`;
          if (futuresChartInstance) {
            futuresChartInstance.setOption({ xAxis: { data: data2.times }, series: [{ type: 'candlestick', data: data2.values }] });
          }
          // 刷新股票行情表
          await renderStockHq();
        }, 60 * 1000);
      }
      $('showFuturesBtn').addEventListener('click', async () => {
        viewMode = 'futures';
        if (futuresTimer) { clearInterval(futuresTimer); futuresTimer = null; }
        setActiveView('futures');
        await renderFutures(selectedDate);
      });

      async function fetchWeekly(date) {
        const res = await fetch(`/futures/week/${date}`);
        if (res.status === 404) return null;
        return await res.json();
      }
      async function renderWeekly(date) {
        updateStatus('周线走势读取中...');
        const data = await fetchWeekly(date);
        if (!data || !Array.isArray(data.values) || data.values.length === 0) {
          showChart(false);
          renderAdvice('');
          updateStatus('该周无期货数据');
          return;
        }
        showChart(true);
        const el = $('futuresChart');
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        const cs = getComputedStyle(document.documentElement);
        const textColor = cs.getPropertyValue('--text').trim();
        const borderColor = cs.getPropertyValue('--border').trim();
        const bgColor = cs.getPropertyValue('--card').trim();
        const chart = echarts.getInstanceByDom(el) || echarts.init(el, isDark ? 'dark' : null);
        futuresChartInstance = chart;
        const fmt = (v) => Number(v).toFixed(2);
        const changeClass = (data.weeklyChange == null) ? '' : (data.weeklyChange >= 0 ? 'up' : 'down');
        $('futuresInfo').innerHTML = `
          <div class="info-row">
            <div class="info-item"><span class="info-label">周一开盘：</span><span class="info-val">${data.mondayOpen != null ? fmt(data.mondayOpen) : '-'}</span></div>
            <div class="info-item"><span class="info-label">周末收盘：</span><span class="info-val ${changeClass}">${data.weekLastClose != null ? fmt(data.weekLastClose) : '-'}</span></div>
            <div class="info-item"><span class="info-label">周涨跌额：</span><span class="info-val ${changeClass}">${data.weeklyChange != null ? (data.weeklyChange >= 0 ? '+' : '') + fmt(data.weeklyChange) : '-'}</span></div>
            <div class="info-item"><span class="info-label">周涨跌幅：</span><span class="info-val ${changeClass}">${data.weeklyChangePct != null ? (data.weeklyChange >= 0 ? '+' : '') + Number(data.weeklyChangePct).toFixed(2) + '%' : '-'}</span></div>
            <div class="info-item"><span class="info-label">区间：</span><span class="info-val">${data.weekStart} 至 ${data.weekEnd}</span></div>
          </div>`;
        const option = {
          title: { text: (data.name || '期货') + '（周线）', left: 'center', textStyle: { fontSize: 14 } },
          tooltip: { trigger: 'axis' },
          backgroundColor: bgColor,
          xAxis: { type: 'category', data: data.times, boundaryGap: true, axisLine: { lineStyle: { color: borderColor } }, axisLabel: { color: textColor } },
          yAxis: { scale: true, min: 'dataMin', max: 'dataMax', splitNumber: 5,
            axisLine: { lineStyle: { color: borderColor } },
            axisLabel: { color: textColor, formatter: (val) => fmt(val), margin: 8 },
            splitLine: { lineStyle: { color: borderColor } }
          },
          series: [{ type: 'candlestick', data: data.values, itemStyle: { color: '#e74c3c', color0: '#2ecc71', borderColor: '#e74c3c', borderColor0: '#2ecc71' } }],
          grid: { left: 32, right: 24, top: 40, bottom: 30, containLabel: true },
          dataZoom: [{ type: 'inside', start: 0, end: 100 }],
          axisPointer: { type: 'cross' }
        };
        chart.setOption(option);
        updateStatus('周线走势展示完成');
        futuresTimer = setInterval(async () => {
          if (viewMode !== 'weekly') return;
          const d2 = await fetchWeekly(selectedDate);
          if (!d2 || !Array.isArray(d2.values) || d2.values.length === 0) return;
          $('futuresInfo').innerHTML = `
            <div class="info-row">
              <div class="info-item"><span class="info-label">周一开盘：</span><span class="info-val">${d2.mondayOpen != null ? fmt(d2.mondayOpen) : '-'}</span></div>
              <div class="info-item"><span class="info-label">周末收盘：</span><span class="info-val ${d2.weeklyChange >= 0 ? 'up' : 'down'}">${d2.weekLastClose != null ? fmt(d2.weekLastClose) : '-'}</span></div>
              <div class="info-item"><span class="info-label">周涨跌额：</span><span class="info-val ${d2.weeklyChange >= 0 ? 'up' : 'down'}">${d2.weeklyChange != null ? (d2.weeklyChange >= 0 ? '+' : '') + fmt(d2.weeklyChange) : '-'}</span></div>
              <div class="info-item"><span class="info-label">周涨跌幅：</span><span class="info-val ${d2.weeklyChange >= 0 ? 'up' : 'down'}">${d2.weeklyChangePct != null ? (d2.weeklyChange >= 0 ? '+' : '') + Number(d2.weeklyChangePct).toFixed(2) + '%' : '-'}</span></div>
              <div class="info-item"><span class="info-label">区间：</span><span class="info-val">${d2.weekStart} 至 ${d2.weekEnd}</span></div>
            </div>`;
          if (futuresChartInstance) {
            futuresChartInstance.setOption({ xAxis: { data: d2.times }, series: [{ type: 'candlestick', data: d2.values }] });
          }
        }, 60 * 1000);
      }
      $('showWeeklyBtn').addEventListener('click', async () => {
        viewMode = 'weekly';
        if (futuresTimer) { clearInterval(futuresTimer); futuresTimer = null; }
        setActiveView('weekly');
        await renderWeekly(selectedDate);
      });

      function showChat(show) {
        $('chatPanel').style.display = show ? 'block' : 'none';
        $('advice').style.display = show ? 'none' : 'block';
        $('futuresChart').style.display = 'none';
        $('futuresInfo').style.display = 'none';
        $('stockHq').style.display = 'none';
      }
      async function fetchChat(date) {
        try {
          const res = await fetch(`/chat/${date}`);
          if (!res.ok) return null;
          return await res.json();
        } catch (e) { return null; }
      }
      function formatDT(s) {
        if (!s) return '-';
        try { const d = new Date(s); return d.toLocaleString(); } catch { return String(s); }
      }
      async function updateChatControls(date) {
        const startBtn = $('startChatBtn');
        const showBtn = $('showChatBtn');
        const syncBtn = $('syncPrevBtn');
        if (!startBtn || !showBtn) return;
        const chat = await fetchChat(date);
        const isToday = date === todayStr;
        // 仅今日允许“开始对话”显示
        startBtn.style.display = (isToday && !chat) ? 'inline-block' : 'none';
        // 今日无聊天时显示“同步上一天”按钮
        if (syncBtn) { syncBtn.style.display = (isToday && !chat) ? 'inline-block' : 'none'; }
        // 动态高亮：若今日且无聊天，高亮开始对话；否则若存在聊天，高亮显示聊天
        startBtn.classList.toggle('btn-cta', Boolean(isToday && !chat));
        showBtn.classList.toggle('btn-cta', Boolean(chat));
      }
      function renderChat(chat) {
        showChat(true);
        const meta = $('chatMeta');
        const box = $('chatMessages');
        meta.innerHTML = `已创建于：${formatDT(chat?.createdAt)}，最近更新时间：${formatDT(chat?.updatedAt || chat?.createdAt)}`;
        box.innerHTML = '';
        const msgs = (chat?.messages || []);
        for (const m of msgs) {
          const row = document.createElement('div');
          row.className = `chat-row ${m.role === 'user' ? 'user' : 'assistant'}`;
          const bubble = document.createElement('div');
          bubble.className = `chat-bubble ${m.role === 'user' ? 'user' : 'assistant'}`;
          const nameEl = document.createElement('div');
          nameEl.className = 'chat-name';
          nameEl.textContent = m.role === 'user' ? '我' : '助理';
          // 轻微样式标签：标记“最新消息增量”
          if (m.tag === 'latest_news' && m.role !== 'user') {
            const badge = document.createElement('span');
            badge.textContent = '最新消息增量';
            badge.style.cssText = 'display:inline-block;margin-left:8px;padding:2px 6px;font-size:11px;color:var(--muted);border:1px solid var(--border);border-radius:10px;';
            nameEl.appendChild(badge);
          }
          const contentEl = document.createElement('div');
          contentEl.className = 'chat-content';
          contentEl.innerHTML = mdToHtml(String(m.content || ''));
          bubble.appendChild(nameEl);
          bubble.appendChild(contentEl);
          row.appendChild(bubble);
          box.appendChild(row);
        }
        box.scrollTop = box.scrollHeight;
      }
      $('showChatBtn').addEventListener('click', async () => {
        viewMode = 'chat';
        setActiveView('chat');
        if (futuresTimer) { clearInterval(futuresTimer); futuresTimer = null; }
        await updateChatControls(selectedDate);
        const chat = await fetchChat(selectedDate);
        if (!chat) {
          renderAdvice('该日暂无聊天记录，请先点击“开始对话”');
          showChat(false);
          updateStatus('无聊天记录');
          return;
        }
        renderChat(chat);
        updateStatus('聊天记录读取完成');
      });
      $('startChatBtn').addEventListener('click', async () => {
        viewMode = 'chat';
        setActiveView('chat');
        if (futuresTimer) { clearInterval(futuresTimer); futuresTimer = null; }
        updateStatus('初始化对话中...');
        const res = await fetch(`/chat/start/${selectedDate}`, { method: 'POST' });
        if (!res.ok) { renderAdvice('初始化对话失败'); showChat(false); updateStatus('初始化失败'); return; }
        const chat = await res.json();
        renderChat(chat);
        updateStatus('对话初始化完成');
        await updateChatControls(selectedDate);
      });

      // ===== Stock HQ rendering =====
      async function fetchStockHq() {
        try {
          const res = await fetch('/stockhq?page=1&num=20&market=O&asc=0&sort=');
          if (!res.ok) return [];
          const json = await res.json();
          return Array.isArray(json?.data) ? json.data : [];
        } catch (e) {
          return [];
        }
      }
      function fmtNum(n) { const v = Number(n); return Number.isFinite(v) ? v : null; }
      function renderStockRows(list) {
        const tbody = document.querySelector('#stockHqTable tbody');
        if (!tbody) return;
        tbody.innerHTML = '';
        for (const it of list) {
          const name = it?.cname || it?.name || '';
          const symbol = it?.symbol || '';
          const price = fmtNum(it?.price);
          const preclose = fmtNum(it?.preclose);
          const open = fmtNum(it?.open);
          const high = fmtNum(it?.high);
          const low = fmtNum(it?.low);
          const diff = fmtNum(it?.diff);
          const chg = fmtNum(it?.chg);
          const mktcap = it?.mktcap != null ? Number(it.mktcap) : null;
          const mktcapDisplay = typeof it?.mktcap_display === 'string'
            ? it.mktcap_display
            : (it?.mktcap_billion != null
              ? `${Number(it.mktcap_billion).toFixed(2)} 亿`
              : (mktcap != null ? ((mktcap / 1e8).toFixed(2) + ' 亿') : '-'));
          const isUp = (diff ?? 0) >= 0;
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="name">${name}</td>
            <td>${symbol}</td>
            <td class="${isUp ? 'chg-up' : 'chg-down'}">${price != null ? price.toFixed(2) : '-'}</td>
            <td class="${isUp ? 'chg-up' : 'chg-down'}">${diff != null ? (isUp ? '+' : '') + diff.toFixed(2) : '-'}</td>
            <td class="${isUp ? 'chg-up' : 'chg-down'}">${chg != null ? (isUp ? '+' : '') + chg.toFixed(2) + '%' : '-'}</td>
            <td>${preclose != null ? preclose.toFixed(2) : '-'}</td>
            <td>${open != null ? open.toFixed(2) : '-'}</td>
            <td>${high != null ? high.toFixed(2) : '-'}</td>
            <td>${low != null ? low.toFixed(2) : '-'}</td>
            <td>${mktcapDisplay}</td>
          `;
          tbody.appendChild(tr);
        }
      }
      async function renderStockHq() {
        const list = await fetchStockHq();
        renderStockRows(list);
      }
      $('syncPrevBtn').addEventListener('click', async () => {
        viewMode = 'chat';
        setActiveView('chat');
        if (futuresTimer) { clearInterval(futuresTimer); futuresTimer = null; }
        updateStatus('同步上一天对话中...');
        const btn = $('syncPrevBtn');
        btn.disabled = true;
        btn.classList.add('active');
        try {
          const res = await fetch(`/chat/${selectedDate}/sync-previous`, { method: 'POST' });
          if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            renderAdvice('同步上一天失败');
            updateStatus(err?.message ? `同步失败：${err.message}` : '同步失败');
          } else {
            const chat = await res.json();
            renderChat(chat);
            updateStatus('已同步上一天对话');
          }
        } catch (e) {
          renderAdvice('同步上一天失败');
          updateStatus('同步失败');
        } finally {
          btn.disabled = false;
          btn.classList.remove('active');
          await updateChatControls(selectedDate);
          await refreshSidebar();
        }
      });
      $('fetchLatestBtn').addEventListener('click', async () => {
        viewMode = 'chat';
        setActiveView('chat');
        if (futuresTimer) { clearInterval(futuresTimer); futuresTimer = null; }
        updateStatus('获取最新消息中...');
        const btn = $('fetchLatestBtn');
        btn.disabled = true;
        btn.classList.add('active');
        try {
          // 流式展示增量建议
          showChat(true);
          const box = $('chatMessages');
          const asRow = document.createElement('div'); asRow.className = 'chat-row assistant';
          const asBubble = document.createElement('div'); asBubble.className = 'chat-bubble assistant';
          const asName = document.createElement('div'); asName.className = 'chat-name'; asName.textContent = '助理';
          const badge = document.createElement('span'); badge.textContent = '最新消息增量'; badge.style.cssText = 'display:inline-block;margin-left:8px;padding:2px 6px;font-size:11px;color:var(--muted);border:1px solid var(--border);border-radius:10px;';
          asName.appendChild(badge);
          const asContent = document.createElement('div'); asContent.className = 'chat-content';
          asBubble.appendChild(asName); asBubble.appendChild(asContent);
          asRow.appendChild(asBubble);
          box.appendChild(asRow);
          box.scrollTop = box.scrollHeight;

          const es = new EventSource(`/chat/${selectedDate}/news/latest/stream`);
          let buffer = '';
          es.onmessage = (ev) => {
            buffer += ev.data;
            asContent.innerHTML = mdToHtml(buffer);
            box.scrollTop = box.scrollHeight;
          };
          es.addEventListener('done', async () => {
            es.close();
            btn.disabled = false;
            btn.classList.remove('active');
            const chat = await fetchChat(selectedDate);
            if (chat) {
              renderChat(chat);
              updateStatus('已基于最新消息更新建议');
            } else {
              updateStatus('已更新，但记录读取失败');
            }
            await updateChatControls(selectedDate);
          });
          es.addEventListener('error', () => {
            es.close();
            btn.disabled = false;
            btn.classList.remove('active');
            updateStatus('获取最新消息失败');
          });
        } catch (e) {
          btn.disabled = false;
          btn.classList.remove('active');
          updateStatus('获取最新消息失败');
        }
      });
      $('sendChatBtn').addEventListener('click', async () => {
        const text = $('chatInput').value.trim();
        if (!text) return;
        $('chatInput').value = '';
        updateStatus('发送消息中...');
        // 禁用发送按钮，避免重复点击
        const sendBtn = $('sendChatBtn');
        sendBtn.disabled = true;
        sendBtn.classList.add('active');
        // 显示聊天面板并立即追加用户消息
        showChat(true);
        const box = $('chatMessages');
        // 用户气泡
        const userRow = document.createElement('div');
        userRow.className = 'chat-row user';
        const userBubble = document.createElement('div');
        userBubble.className = 'chat-bubble user';
        const userName = document.createElement('div'); userName.className = 'chat-name'; userName.textContent = '我';
        const userContent = document.createElement('div'); userContent.className = 'chat-content'; userContent.innerHTML = mdToHtml(text);
        userBubble.appendChild(userName); userBubble.appendChild(userContent);
        userRow.appendChild(userBubble);
        box.appendChild(userRow);
        // 助理占位气泡
        const asRow = document.createElement('div'); asRow.className = 'chat-row assistant';
        const asBubble = document.createElement('div'); asBubble.className = 'chat-bubble assistant';
        const asName = document.createElement('div'); asName.className = 'chat-name'; asName.textContent = '助理';
        const asContent = document.createElement('div'); asContent.className = 'chat-content';
        asBubble.appendChild(asName); asBubble.appendChild(asContent);
        asRow.appendChild(asBubble);
        box.appendChild(asRow);
        let buffer = '';
        box.scrollTop = box.scrollHeight;

        const es = new EventSource(`/chat/${selectedDate}/message/stream?text=${encodeURIComponent(text)}`);
        es.onmessage = (ev) => {
          buffer += ev.data;
          asContent.innerHTML = mdToHtml(buffer);
          box.scrollTop = box.scrollHeight;
        };
        es.addEventListener('done', async () => {
          es.close();
          // 重新启用按钮
          sendBtn.disabled = false;
          sendBtn.classList.remove('active');
          // 拉取完整记录并渲染（包含 meta）
          const chat = await fetchChat(selectedDate);
          if (chat) {
            renderChat(chat);
            updateStatus('回复完成');
          } else {
            updateStatus('回复完成，但记录读取失败');
          }
        });
        es.addEventListener('error', () => {
          es.close();
          sendBtn.disabled = false;
          sendBtn.classList.remove('active');
          updateStatus('发送失败');
        });
      });
      $('addPosBtn').addEventListener('click', async () => {
        const category = ($('assetCategory').value || 'fund');
        const assetName = $('assetName').value.trim();
        const assetAmountVal = Number(($('assetAmount').value || '').trim());
        const note = $('posNote').value.trim();
        if (!assetName || !Number.isFinite(assetAmountVal) || assetAmountVal < 0) {
          $('status').textContent = '状态：请填写资产名称与非负金额（元）';
          return;
        }
        const entry = { assetName, amount: assetAmountVal, note, category };
        const next = currentPositions.slice(); next.push(entry);
        currentPositions = next;
        await savePositions(next);
        renderPositions();
        $('assetName').value = '';
        $('assetAmount').value = '';
        $('posNote').value = '';
      });

      refreshSidebar();
      loadAllForDate(selectedDate);
    </script>
  </body>
</html>